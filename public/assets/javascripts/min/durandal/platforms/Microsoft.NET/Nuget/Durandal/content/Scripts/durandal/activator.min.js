
define(['durandal/system','knockout'],function(system,ko){var activator;var defaultOptions={canDeactivate:true};function ensureSettings(settings){if(settings==undefined){settings={};}
if(!system.isBoolean(settings.closeOnDeactivate)){settings.closeOnDeactivate=activator.defaults.closeOnDeactivate;}
if(!settings.beforeActivate){settings.beforeActivate=activator.defaults.beforeActivate;}
if(!settings.afterDeactivate){settings.afterDeactivate=activator.defaults.afterDeactivate;}
if(!settings.affirmations){settings.affirmations=activator.defaults.affirmations;}
if(!settings.interpretResponse){settings.interpretResponse=activator.defaults.interpretResponse;}
if(!settings.areSameItem){settings.areSameItem=activator.defaults.areSameItem;}
if(!settings.findChildActivator){settings.findChildActivator=activator.defaults.findChildActivator;}
return settings;}
function invoke(target,method,data){if(system.isArray(data)){return target[method].apply(target,data);}
return target[method](data);}
function deactivate(item,close,settings,dfd,setter){if(item&&item.deactivate){system.log('Deactivating',item);var result;try{result=item.deactivate(close);}catch(error){system.log('ERROR: '+error.message,error);dfd.resolve(false);return;}
if(result&&result.then){result.then(function(){settings.afterDeactivate(item,close,setter);dfd.resolve(true);},function(reason){system.log(reason);dfd.resolve(false);});}else{settings.afterDeactivate(item,close,setter);dfd.resolve(true);}}else{if(item){settings.afterDeactivate(item,close,setter);}
dfd.resolve(true);}}
function activate(newItem,activeItem,callback,activationData){var result;if(newItem&&newItem.activate){system.log('Activating',newItem);try{result=invoke(newItem,'activate',activationData);}catch(error){system.log('ERROR: '+error.message,error);callback(false);return;}}
if(result&&result.then){result.then(function(){activeItem(newItem);callback(true);},function(reason){system.log('ERROR: '+reason.message,reason);callback(false);});}else{activeItem(newItem);callback(true);}}
function canDeactivateItem(item,close,settings,options){options=system.extend({},defaultOptions,options);settings.lifecycleData=null;return system.defer(function(dfd){function continueCanDeactivate(){if(item&&item.canDeactivate&&options.canDeactivate){var resultOrPromise;try{resultOrPromise=item.canDeactivate(close);}catch(error){system.log('ERROR: '+error.message,error);dfd.resolve(false);return;}
if(resultOrPromise.then){resultOrPromise.then(function(result){settings.lifecycleData=result;dfd.resolve(settings.interpretResponse(result));},function(reason){system.log('ERROR: '+reason.message,reason);dfd.resolve(false);});}else{settings.lifecycleData=resultOrPromise;dfd.resolve(settings.interpretResponse(resultOrPromise));}}else{dfd.resolve(true);}}
var childActivator=settings.findChildActivator(item);if(childActivator){childActivator.canDeactivate().then(function(result){if(result){continueCanDeactivate();}else{dfd.resolve(false);}});}else{continueCanDeactivate();}}).promise();};function canActivateItem(newItem,activeItem,settings,activeData,newActivationData){settings.lifecycleData=null;return system.defer(function(dfd){if(settings.areSameItem(activeItem(),newItem,activeData,newActivationData)){dfd.resolve(true);return;}
if(newItem&&newItem.canActivate){var resultOrPromise;try{resultOrPromise=invoke(newItem,'canActivate',newActivationData);}catch(error){system.log('ERROR: '+error.message,error);dfd.resolve(false);return;}
if(resultOrPromise.then){resultOrPromise.then(function(result){settings.lifecycleData=result;dfd.resolve(settings.interpretResponse(result));},function(reason){system.log('ERROR: '+reason.message,reason);dfd.resolve(false);});}else{settings.lifecycleData=resultOrPromise;dfd.resolve(settings.interpretResponse(resultOrPromise));}}else{dfd.resolve(true);}}).promise();};function createActivator(initialActiveItem,settings){var activeItem=ko.observable(null);var activeData;settings=ensureSettings(settings);var computed=ko.computed({read:function(){return activeItem();},write:function(newValue){computed.viaSetter=true;computed.activateItem(newValue);}});computed.__activator__=true;computed.settings=settings;settings.activator=computed;computed.isActivating=ko.observable(false);computed.forceActiveItem=function(item){activeItem(item);};computed.canDeactivateItem=function(item,close,options){return canDeactivateItem(item,close,settings,options);};computed.deactivateItem=function(item,close){return system.defer(function(dfd){computed.canDeactivateItem(item,close).then(function(canDeactivate){if(canDeactivate){deactivate(item,close,settings,dfd,activeItem);}else{computed.notifySubscribers();dfd.resolve(false);}});}).promise();};computed.canActivateItem=function(newItem,activationData){return canActivateItem(newItem,activeItem,settings,activeData,activationData);};computed.activateItem=function(newItem,newActivationData,options){var viaSetter=computed.viaSetter;computed.viaSetter=false;return system.defer(function(dfd){if(computed.isActivating()){dfd.resolve(false);return;}
computed.isActivating(true);var currentItem=activeItem();if(settings.areSameItem(currentItem,newItem,activeData,newActivationData)){computed.isActivating(false);dfd.resolve(true);return;}
computed.canDeactivateItem(currentItem,settings.closeOnDeactivate,options).then(function(canDeactivate){if(canDeactivate){computed.canActivateItem(newItem,newActivationData).then(function(canActivate){if(canActivate){system.defer(function(dfd2){deactivate(currentItem,settings.closeOnDeactivate,settings,dfd2);}).promise().then(function(){newItem=settings.beforeActivate(newItem,newActivationData);activate(newItem,activeItem,function(result){activeData=newActivationData;computed.isActivating(false);dfd.resolve(result);},newActivationData);});}else{if(viaSetter){computed.notifySubscribers();}
computed.isActivating(false);dfd.resolve(false);}});}else{if(viaSetter){computed.notifySubscribers();}
computed.isActivating(false);dfd.resolve(false);}});}).promise();};computed.canActivate=function(){var toCheck;if(initialActiveItem){toCheck=initialActiveItem;initialActiveItem=false;}else{toCheck=computed();}
return computed.canActivateItem(toCheck);};computed.activate=function(){var toActivate;if(initialActiveItem){toActivate=initialActiveItem;initialActiveItem=false;}else{toActivate=computed();}
return computed.activateItem(toActivate);};computed.canDeactivate=function(close){return computed.canDeactivateItem(computed(),close);};computed.deactivate=function(close){return computed.deactivateItem(computed(),close);};computed.includeIn=function(includeIn){includeIn.canActivate=function(){return computed.canActivate();};includeIn.activate=function(){return computed.activate();};includeIn.canDeactivate=function(close){return computed.canDeactivate(close);};includeIn.deactivate=function(close){return computed.deactivate(close);};};if(settings.includeIn){computed.includeIn(settings.includeIn);}else if(initialActiveItem){computed.activate();}
computed.forItems=function(items){settings.closeOnDeactivate=false;settings.determineNextItemToActivate=function(list,lastIndex){var toRemoveAt=lastIndex-1;if(toRemoveAt==-1&&list.length>1){return list[1];}
if(toRemoveAt>-1&&toRemoveAt<list.length-1){return list[toRemoveAt];}
return null;};settings.beforeActivate=function(newItem){var currentItem=computed();if(!newItem){newItem=settings.determineNextItemToActivate(items,currentItem?items.indexOf(currentItem):0);}else{var index=items.indexOf(newItem);if(index==-1){items.push(newItem);}else{newItem=items()[index];}}
return newItem;};settings.afterDeactivate=function(oldItem,close){if(close){items.remove(oldItem);}};var originalCanDeactivate=computed.canDeactivate;computed.canDeactivate=function(close){if(close){return system.defer(function(dfd){var list=items();var results=[];function finish(){for(var j=0;j<results.length;j++){if(!results[j]){dfd.resolve(false);return;}}
dfd.resolve(true);}
for(var i=0;i<list.length;i++){computed.canDeactivateItem(list[i],close).then(function(result){results.push(result);if(results.length==list.length){finish();}});}}).promise();}else{return originalCanDeactivate();}};var originalDeactivate=computed.deactivate;computed.deactivate=function(close){if(close){return system.defer(function(dfd){var list=items();var results=0;var listLength=list.length;function doDeactivate(item){setTimeout(function(){computed.deactivateItem(item,close).then(function(){results++;items.remove(item);if(results==listLength){dfd.resolve();}});},1);}
for(var i=0;i<listLength;i++){doDeactivate(list[i]);}}).promise();}else{return originalDeactivate();}};return computed;};return computed;}
var activatorSettings={closeOnDeactivate:true,affirmations:['yes','ok','true'],interpretResponse:function(value){if(system.isObject(value)){value=value.can||false;}
if(system.isString(value)){return ko.utils.arrayIndexOf(this.affirmations,value.toLowerCase())!==-1;}
return value;},areSameItem:function(currentItem,newItem,currentActivationData,newActivationData){return currentItem==newItem;},beforeActivate:function(newItem){return newItem;},afterDeactivate:function(oldItem,close,setter){if(close&&setter){setter(null);}},findChildActivator:function(item){return null;}};activator={defaults:activatorSettings,create:createActivator,isActivator:function(object){return object&&object.__activator__;}};return activator;});