
define(['durandal/system','durandal/viewEngine'],function(system,viewEngine){function findInElements(nodes,url){for(var i=0;i<nodes.length;i++){var current=nodes[i];var existingUrl=current.getAttribute('data-view');if(existingUrl==url){return current;}}}
function escape(str){return(str+'').replace(/([\\\.\+\*\?\[\^\]\$\(\)\{\}\=\!\<\>\|\:])/g,"\\$1");}
return{useConvention:function(modulesPath,viewsPath,areasPath){modulesPath=modulesPath||'viewmodels';viewsPath=viewsPath||'views';areasPath=areasPath||viewsPath;var reg=new RegExp(escape(modulesPath),'gi');this.convertModuleIdToViewId=function(moduleId){return moduleId.replace(reg,viewsPath);};this.translateViewIdToArea=function(viewId,area){if(!area||area=='partial'){return areasPath+'/'+viewId;}
return areasPath+'/'+area+'/'+viewId;};},locateViewForObject:function(obj,area,elementsToSearch){var view;if(obj.getView){view=obj.getView();if(view){return this.locateView(view,area,elementsToSearch);}}
if(obj.viewUrl){return this.locateView(obj.viewUrl,area,elementsToSearch);}
var id=system.getModuleId(obj);if(id){return this.locateView(this.convertModuleIdToViewId(id),area,elementsToSearch);}
return this.locateView(this.determineFallbackViewId(obj),area,elementsToSearch);},convertModuleIdToViewId:function(moduleId){return moduleId;},determineFallbackViewId:function(obj){var funcNameRegex=/function (.{1,})\(/;var results=(funcNameRegex).exec((obj).constructor.toString());var typeName=(results&&results.length>1)?results[1]:"";typeName=typeName.trim();return'views/'+typeName;},translateViewIdToArea:function(viewId,area){return viewId;},locateView:function(viewOrUrlOrId,area,elementsToSearch){if(typeof viewOrUrlOrId==='string'){var viewId;if(viewEngine.isViewUrl(viewOrUrlOrId)){viewId=viewEngine.convertViewUrlToViewId(viewOrUrlOrId);}else{viewId=viewOrUrlOrId;}
if(area){viewId=this.translateViewIdToArea(viewId,area);}
if(elementsToSearch){var existing=findInElements(elementsToSearch,viewId);if(existing){return system.defer(function(dfd){dfd.resolve(existing);}).promise();}}
return viewEngine.createView(viewId);}
return system.defer(function(dfd){dfd.resolve(viewOrUrlOrId);}).promise();}};});