
define(['durandal/system','jquery'],function(system,$){var routeStripper=/^[#\/]|\s+$/g;var rootStripper=/^\/+|\/+$/g;var isExplorer=/msie [\w.]+/;var trailingSlash=/\/$/;function updateHash(location,fragment,replace){if(replace){var href=location.href.replace(/(javascript:|#).*$/,'');if(history.history.replaceState){history.history.replaceState({},document.title,href+'#'+fragment);}else{location.replace(href+'#'+fragment);}}else{location.hash='#'+fragment;}};var history={interval:50,active:false};if(typeof window!=='undefined'){history.location=window.location;history.history=window.history;}
history.getHash=function(window){var match=(window||history).location.href.match(/#(.*)$/);return match?match[1]:'';};history.getFragment=function(fragment,forcePushState){if(fragment==null){if(history._hasPushState||!history._wantsHashChange||forcePushState){fragment=history.location.pathname+history.location.search;var root=history.root.replace(trailingSlash,'');if(!fragment.indexOf(root)){fragment=fragment.substr(root.length);}}else{fragment=history.getHash();}}
return fragment.replace(routeStripper,'');};history.activate=function(options){if(history.active){system.error("History has already been activated.");}
history.active=true;history.options=system.extend({},{root:'/'},history.options,options);history.root=history.options.root;history._wantsHashChange=history.options.hashChange!==false;history._wantsPushState=!!history.options.pushState;history._hasPushState=!!(history.options.pushState&&history.history&&history.history.pushState);var fragment=history.getFragment();var docMode=document.documentMode;var oldIE=(isExplorer.exec(navigator.userAgent.toLowerCase())&&(!docMode||docMode<=7));history.root=('/'+history.root+'/').replace(rootStripper,'/');if(oldIE&&history._wantsHashChange){history.iframe=$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo('body')[0].contentWindow;history.navigate(fragment,false);}
if(history._hasPushState){$(window).on('popstate',history.checkUrl);}else if(history._wantsHashChange&&('onhashchange'in window)&&!oldIE){$(window).on('hashchange',history.checkUrl);}else if(history._wantsHashChange){history._checkUrlInterval=setInterval(history.checkUrl,history.interval);}
history.fragment=fragment;var loc=history.location;var atRoot=loc.pathname.replace(/[^\/]$/,'$&/')===history.root;if(history._wantsHashChange&&history._wantsPushState){if(!history._hasPushState&&!atRoot){history.fragment=history.getFragment(null,true);history.location.replace(history.root+history.location.search+'#'+history.fragment);return true;}else if(history._hasPushState&&atRoot&&loc.hash){this.fragment=history.getHash().replace(routeStripper,'');this.history.replaceState({},document.title,history.root+history.fragment+loc.search);}}
if(!history.options.silent){return history.loadUrl(options.startRoute);}};history.deactivate=function(){$(window).off('popstate',history.checkUrl).off('hashchange',history.checkUrl);clearInterval(history._checkUrlInterval);history.active=false;};history.checkUrl=function(){var current=history.getFragment();if(current===history.fragment&&history.iframe){current=history.getFragment(history.getHash(history.iframe));}
if(current===history.fragment){return false;}
if(history.iframe){history.navigate(current,false);}
history.loadUrl();};history.loadUrl=function(fragmentOverride){var fragment=history.fragment=history.getFragment(fragmentOverride);return history.options.routeHandler?history.options.routeHandler(fragment):false;};history.navigate=function(fragment,options){if(!history.active){return false;}
if(options===undefined){options={trigger:true};}else if(system.isBoolean(options)){options={trigger:options};}
fragment=history.getFragment(fragment||'');if(history.fragment===fragment){return;}
history.fragment=fragment;var url=history.root+fragment;if(fragment===''&&url!=='/'){url=url.slice(0,-1);}
if(history._hasPushState){history.history[options.replace?'replaceState':'pushState']({},document.title,url);}else if(history._wantsHashChange){updateHash(history.location,fragment,options.replace);if(history.iframe&&(fragment!==history.getFragment(history.getHash(history.iframe)))){if(!options.replace){history.iframe.document.open().close();}
updateHash(history.iframe.location,fragment,options.replace);}}else{return history.location.assign(url);}
if(options.trigger){return history.loadUrl(fragment);}};history.navigateBack=function(){history.history.back();};return history;});