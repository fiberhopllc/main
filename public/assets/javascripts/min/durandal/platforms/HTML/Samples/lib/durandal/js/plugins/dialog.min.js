
define(['durandal/system','durandal/app','durandal/composition','durandal/activator','durandal/viewEngine','jquery','knockout'],function(system,app,composition,activator,viewEngine,$,ko){var contexts={},dialogCount=ko.observable(0),dialog;var MessageBox=function(message,title,options,autoclose,settings){this.message=message;this.title=title||MessageBox.defaultTitle;this.options=options||MessageBox.defaultOptions;this.autoclose=autoclose||false;this.settings=$.extend({},MessageBox.defaultSettings,settings);};MessageBox.prototype.selectOption=function(dialogResult){dialog.close(this,dialogResult);};MessageBox.prototype.getView=function(){return viewEngine.processMarkup(MessageBox.defaultViewMarkup);};MessageBox.setViewUrl=function(viewUrl){delete MessageBox.prototype.getView;MessageBox.prototype.viewUrl=viewUrl;};MessageBox.defaultTitle=app.title||'Application';MessageBox.defaultOptions=['Ok'];MessageBox.defaultSettings={buttonClass:"btn btn-default",primaryButtonClass:"btn-primary autofocus",secondaryButtonClass:"","class":"modal-content messageBox",style:null};MessageBox.setDefaults=function(settings){$.extend(MessageBox.defaultSettings,settings);};MessageBox.prototype.getButtonClass=function($index){var c="";if(this.settings){if(this.settings.buttonClass){c=this.settings.buttonClass;}
if($index()===0&&this.settings.primaryButtonClass){if(c.length>0){c+=" ";}
c+=this.settings.primaryButtonClass;}
if($index()>0&&this.settings.secondaryButtonClass){if(c.length>0){c+=" ";}
c+=this.settings.secondaryButtonClass;}}
return c;};MessageBox.prototype.getClass=function(){if(this.settings){return this.settings["class"];}
return"messageBox";};MessageBox.prototype.getStyle=function(){if(this.settings){return this.settings.style;}
return null;};MessageBox.prototype.getButtonText=function(stringOrObject){var t=$.type(stringOrObject);if(t==="string"){return stringOrObject;}
else if(t==="object"){if($.type(stringOrObject.text)==="string"){return stringOrObject.text;}else{system.error('The object for a MessageBox button does not have a text property that is a string.');return null;}}
system.error('Object for a MessageBox button is not a string or object but '+t+'.');return null;};MessageBox.prototype.getButtonValue=function(stringOrObject){var t=$.type(stringOrObject);if(t==="string"){return stringOrObject;}
else if(t==="object"){if($.type(stringOrObject.text)==="undefined"){system.error('The object for a MessageBox button does not have a value property defined.');return null;}else{return stringOrObject.value;}}
system.error('Object for a MessageBox button is not a string or object but '+t+'.');return null;};MessageBox.defaultViewMarkup=['<div data-view="plugins/messageBox" data-bind="css: getClass(), style: getStyle()">','<div class="modal-header">','<h3 data-bind="html: title"></h3>','</div>','<div class="modal-body">','<p class="message" data-bind="html: message"></p>','</div>','<div class="modal-footer">','<!-- ko foreach: options -->','<button data-bind="click: function () { $parent.selectOption($parent.getButtonValue($data)); }, text: $parent.getButtonText($data), css: $parent.getButtonClass($index)"></button>','<!-- /ko -->','<div style="clear:both;"></div>','</div>','</div>'].join('\n');function ensureDialogInstance(objOrModuleId){return system.defer(function(dfd){if(system.isString(objOrModuleId)){system.acquire(objOrModuleId).then(function(module){dfd.resolve(system.resolveObject(module));}).fail(function(err){system.error('Failed to load dialog module ('+objOrModuleId+'). Details: '+err.message);});}else{dfd.resolve(objOrModuleId);}}).promise();}
dialog={MessageBox:MessageBox,currentZIndex:1050,getNextZIndex:function(){return++this.currentZIndex;},isOpen:ko.computed(function(){return dialogCount()>0;}),getContext:function(name){return contexts[name||'default'];},addContext:function(name,dialogContext){dialogContext.name=name;contexts[name]=dialogContext;var helperName='show'+name.substr(0,1).toUpperCase()+name.substr(1);this[helperName]=function(obj,activationData){return this.show(obj,activationData,name);};},createCompositionSettings:function(obj,dialogContext){var settings={model:obj,activate:false,transition:false};if(dialogContext.binding){settings.binding=dialogContext.binding;}
if(dialogContext.attached){settings.attached=dialogContext.attached;}
if(dialogContext.compositionComplete){settings.compositionComplete=dialogContext.compositionComplete;}
return settings;},getDialog:function(obj){if(obj){return obj.__dialog__;}
return undefined;},close:function(obj){var theDialog=this.getDialog(obj);if(theDialog){var rest=Array.prototype.slice.call(arguments,1);theDialog.close.apply(theDialog,rest);}},show:function(obj,activationData,context){var that=this;var dialogContext=contexts[context||'default'];return system.defer(function(dfd){ensureDialogInstance(obj).then(function(instance){var dialogActivator=activator.create();dialogActivator.activateItem(instance,activationData).then(function(success){if(success){var theDialog=instance.__dialog__={owner:instance,context:dialogContext,activator:dialogActivator,close:function(){var args=arguments;dialogActivator.deactivateItem(instance,true).then(function(closeSuccess){if(closeSuccess){dialogCount(dialogCount()-1);dialogContext.removeHost(theDialog);delete instance.__dialog__;if(args.length===0){dfd.resolve();}else if(args.length===1){dfd.resolve(args[0]);}else{dfd.resolve.apply(dfd,args);}}});}};theDialog.settings=that.createCompositionSettings(instance,dialogContext);dialogContext.addHost(theDialog);dialogCount(dialogCount()+1);composition.compose(theDialog.host,theDialog.settings);}else{dfd.resolve(false);}});});}).promise();},showMessage:function(message,title,options,autoclose,settings){if(system.isString(this.MessageBox)){return dialog.show(this.MessageBox,[message,title||MessageBox.defaultTitle,options||MessageBox.defaultOptions,autoclose||false,settings||{}]);}
return dialog.show(new this.MessageBox(message,title,options,autoclose,settings));},install:function(config){app.showDialog=function(obj,activationData,context){return dialog.show(obj,activationData,context);};app.closeDialog=function(){return dialog.close.apply(dialog,arguments);};app.showMessage=function(message,title,options,autoclose,settings){return dialog.showMessage(message,title,options,autoclose,settings);};if(config.messageBox){dialog.MessageBox=config.messageBox;}
if(config.messageBoxView){dialog.MessageBox.prototype.getView=function(){return viewEngine.processMarkup(config.messageBoxView);};}
if(config.messageBoxViewUrl){dialog.MessageBox.setViewUrl(config.messageBoxViewUrl);}}};dialog.addContext('default',{blockoutOpacity:0.2,removeDelay:200,addHost:function(theDialog){var body=$('body');var blockout=$('<div class="modalBlockout"></div>').css({'z-index':dialog.getNextZIndex(),'opacity':this.blockoutOpacity}).appendTo(body);var host=$('<div class="modalHost"></div>').css({'z-index':dialog.getNextZIndex()}).appendTo(body);theDialog.host=host.get(0);theDialog.blockout=blockout.get(0);if(!dialog.isOpen()){theDialog.oldBodyMarginRight=body.css("margin-right");theDialog.oldInlineMarginRight=body.get(0).style.marginRight;var html=$("html");var oldBodyOuterWidth=body.outerWidth(true);var oldScrollTop=html.scrollTop();$("html").css("overflow-y","hidden");var newBodyOuterWidth=$("body").outerWidth(true);body.css("margin-right",(newBodyOuterWidth-oldBodyOuterWidth+parseInt(theDialog.oldBodyMarginRight,10))+"px");html.scrollTop(oldScrollTop);}},removeHost:function(theDialog){$(theDialog.host).css('opacity',0);$(theDialog.blockout).css('opacity',0);setTimeout(function(){ko.removeNode(theDialog.host);ko.removeNode(theDialog.blockout);},this.removeDelay);if(!dialog.isOpen()){var html=$("html");var oldScrollTop=html.scrollTop();html.css("overflow-y","").scrollTop(oldScrollTop);if(theDialog.oldInlineMarginRight){$("body").css("margin-right",theDialog.oldBodyMarginRight);}else{$("body").css("margin-right",'');}}},attached:function(view){$(view).css("visibility","hidden");},compositionComplete:function(child,parent,context){var theDialog=dialog.getDialog(context.model);var $child=$(child);var loadables=$child.find("img").filter(function(){var $this=$(this);return!(this.style.width&&this.style.height)&&!($this.attr("width")&&$this.attr("height"));});$child.data("predefinedWidth",$child.get(0).style.width);var setDialogPosition=function(childView,objDialog){setTimeout(function(){var $childView=$(childView);objDialog.context.reposition(childView);$(objDialog.host).css('opacity',1);$childView.css("visibility","visible");$childView.find('.autofocus').first().focus();},1);};setDialogPosition(child,theDialog);loadables.load(function(){setDialogPosition(child,theDialog);});if($child.hasClass('autoclose')||context.model.autoclose){$(theDialog.blockout).click(function(){theDialog.close();});}},reposition:function(view){var $view=$(view),$window=$(window);if(!$view.data("predefinedWidth")){$view.css({width:''});}
var width=$view.outerWidth(false),height=$view.outerHeight(false),windowHeight=$window.height()-10,windowWidth=$window.width()-10,constrainedHeight=Math.min(height,windowHeight),constrainedWidth=Math.min(width,windowWidth);$view.css({'margin-top':(-constrainedHeight/2).toString()+'px','margin-left':(-constrainedWidth/2).toString()+'px'});if(height>windowHeight){$view.css("overflow-y","auto").outerHeight(windowHeight);}else{$view.css({"overflow-y":"","height":""});}
if(width>windowWidth){$view.css("overflow-x","auto").outerWidth(windowWidth);}else{$view.css("overflow-x","");if(!$view.data("predefinedWidth")){$view.outerWidth(constrainedWidth);}else{$view.css("width",$view.data("predefinedWidth"));}}}});return dialog;});