
define(['durandal/system','jquery'],function(system,$){var parseMarkup;if($.parseHTML){parseMarkup=function(html){return $.parseHTML(html);};}else{parseMarkup=function(html){return $(html).get();};}
return{cache:{},viewExtension:'.html',viewPlugin:'text',viewPluginParameters:'',isViewUrl:function(url){return url.indexOf(this.viewExtension,url.length-this.viewExtension.length)!==-1;},convertViewUrlToViewId:function(url){return url.substring(0,url.length-this.viewExtension.length);},convertViewIdToRequirePath:function(viewId){var plugin=this.viewPlugin?this.viewPlugin+'!':'';return plugin+viewId+this.viewExtension+this.viewPluginParameters;},parseMarkup:parseMarkup,processMarkup:function(markup){var allElements=this.parseMarkup(markup);return this.ensureSingleElement(allElements);},ensureSingleElement:function(allElements){if(allElements.length==1){return allElements[0];}
var withoutCommentsOrEmptyText=[];for(var i=0;i<allElements.length;i++){var current=allElements[i];if(current.nodeType!=8){if(current.nodeType==3){var result=/\S/.test(current.nodeValue);if(!result){continue;}}
withoutCommentsOrEmptyText.push(current);}}
if(withoutCommentsOrEmptyText.length>1){return $(withoutCommentsOrEmptyText).wrapAll('<div class="durandal-wrapper"></div>').parent().get(0);}
return withoutCommentsOrEmptyText[0];},tryGetViewFromCache:function(id){return this.cache[id];},putViewInCache:function(id,view){this.cache[id]=view;},createView:function(viewId){var that=this;var requirePath=this.convertViewIdToRequirePath(viewId);var existing=this.tryGetViewFromCache(requirePath);if(existing){return system.defer(function(dfd){dfd.resolve(existing.cloneNode(true));}).promise();}
return system.defer(function(dfd){system.acquire(requirePath).then(function(markup){var element=that.processMarkup(markup);element.setAttribute('data-view',viewId);that.putViewInCache(requirePath,element);dfd.resolve(element.cloneNode(true));}).fail(function(err){that.createFallbackView(viewId,requirePath,err).then(function(element){element.setAttribute('data-view',viewId);that.cache[requirePath]=element;dfd.resolve(element.cloneNode(true));});});}).promise();},createFallbackView:function(viewId,requirePath,err){var that=this,message='View Not Found. Searched for "'+viewId+'" via path "'+requirePath+'".';return system.defer(function(dfd){dfd.resolve(that.processMarkup('<div class="durandal-view-404">'+message+'</div>'));}).promise();}};});